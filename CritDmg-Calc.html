<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Critical Damage Calculator (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-neutral-950 text-neutral-100">
    <div id="root"></div>

    <!-- React (you can keep dev builds while iterating) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-presets="react">
      const { useMemo, useState } = React; 

      function ESOCritCalculator() {
        const [cap, setCap] = useState(125);

        const [effects, setEffects] = useState(() => [
          { id: "base", name: "Base Character Critical Damage", perStack: 50, stacks: 1, maxStacks: 1, on: true, locked: true, note: "Default base crit dmg." },
          { id: "minorForce", name: "Minor Force", perStack: 10, stacks: 1, maxStacks: 1, on: false },
          { id: "majorForce", name: "Major Force", perStack: 20, stacks: 1, maxStacks: 1, on: false },
          { id: "minorBrittle", name: "Minor Brittle", perStack: 10, stacks: 1, maxStacks: 1, on: false },
          { id: "majorBrittle", name: "Major Brittle", perStack: 20, stacks: 1, maxStacks: 1, on: false },
          { id: "elementalCatalyst", name: "Elemental Catalyst (per status)", perStack: 5, stacks: 0, maxStacks: 3, on: false },
          { id: "lucentEchoes", name: "Lucent Echoes", perStack: 11, stacks: 0, maxStacks: 1, on: false },
          { id: "felineAmbush", name: "Khajiit Passive: Feline Ambush", perStack: 12, stacks: 1, maxStacks: 1, on: false },
          { id: "sulXan", name: "Sul-Xan's Torment", perStack: 12, stacks: 0, maxStacks: 1, on: false },
          { id: "moraScribe", name: "Mora Scribe's Thesis", perStack: 1, stacks: 0, maxStacks: 12, on: false },
          { id: "heraldTome", name: "Herald of the Tome: Fated Fortune", perStack: 12, stacks: 0, maxStacks: 1, on: false },
          { id: "assassination", name: "Assassination: Hemorrhage", perStack: 10, stacks: 0, maxStacks: 1, on: false },
          { id: "aedricSpear", name: "Aedric Spear: Piercing Spear", perStack: 12, stacks: 0, maxStacks: 1, on: false },
          { id: "companion", name: "Animal Companions: Advanced Species", perStack: 5, stacks: 0, maxStacks: 6, on: false },
          { id: "mediumDex", name: "Medium Armor Passive: Dexterity (per piece)", perStack: 2, stacks: 0, maxStacks: 7, on: false },
          { id: "harpooner", name: "Harpooner's Wading Kilt (per stack)", perStack: 1, stacks: 0, maxStacks: 10, on: false },
          { id: "fightingFinesse", name: "Fighting Finesse (CP)", perStack: 8, stacks: 0, maxStacks: 1, on: false },
          { id: "backstabber", name: "Backstabber (CP)", perStack: 10, stacks: 0, maxStacks: 1, on: false },
          { id: "dwAxe", name: "Dual Wield Passive: Twin Blade & Blunt (Axe)", perStack: 6, stacks: 0, maxStacks: 2, on: false },
          { id: "2hAxe", name: "Two Handed Passive: Heavy Weapons (Axe)", perStack: 12, stacks: 0, maxStacks: 1, on: false },
        ]);

        const totals = React.useMemo(() => {
          const rows = effects.map((e) => ({
            ...e,
            line: e.on ? round2(e.perStack * clamp(e.stacks, 0, e.maxStacks)) : 0,
          }));
          const raw = round2(rows.reduce((s, r) => s + r.line, 0));
          const capped = Math.min(raw, cap);
          return { rows, raw, capped };
        }, [effects, cap]);

        function update(id, patch) {
          setEffects((prev) => prev.map((e) => (e.id === id ? { ...e, ...patch } : e)));
        }

        function addCustom() {
          const idx = effects.length + 1;
          setEffects((prev) => [
            ...prev,
            { id: `custom_${idx}`,
              name: `Custom Modifier ${idx}`,
              perStack: 1,
              stacks: 0,
              maxStacks: 1,
              on: false,
            },
          ]);
        }

        function resetAll() {
          setEffects((prev) => prev.map((e) => ({ ...e, on: e.locked || false, stacks: e.locked ? 1 : 0 })));
        }

        function exportConfig() {
          const payload = {
            cap,
            effects: effects.map(({ id, name, perStack, maxStacks }) => ({ id, name, perStack, maxStacks })),
          };
          if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(JSON.stringify(payload, null, 2));
            alert("Config copied to clipboard as JSON.");
          } else {
            const ta = document.createElement('textarea');
            ta.value = JSON.stringify(payload, null, 2);
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert("Config copied to clipboard (fallback).");
          }
        }

        function importConfig() {
          const text = prompt("Paste config JSON");
          if (!text) return;
          try {
            const cfg = JSON.parse(text);
            setCap(cfg.cap ?? 125);
            setEffects((prev) => {
              const map = new Map(prev.map((e) => [e.id, e]));
              for (const row of (cfg.effects || [])) {
                const cur = map.get(row.id);
                if (cur) {
                  map.set(row.id, { ...cur, name: row.name ?? cur.name, perStack: row.perStack ?? cur.perStack, maxStacks: row.maxStacks ?? cur.maxStacks });
                } else {
                  map.set(row.id, { id: row.id, name: row.name || row.id, perStack: row.perStack || 0, maxStacks: row.maxStacks || 1, stacks: 0, on: false });
                }
              }
              return Array.from(map.values());
            });
          } catch (e) {
            alert("Invalid JSON");
          }
        }

        return (
          <div className="min-h-screen bg-neutral-950 text-neutral-100">
            {/* Top Bar with three links (same style as your other page) */}
            <header className="sticky top-0 z-10 border-b border-neutral-800 bg-neutral-950/80 backdrop-blur">
              <div className="mx-auto flex max-w-5xl items-center justify-between px-4 py-3">
                <a href="index.html" className="text-lg font-semibold text-orange-500">
                  Skooma Tools
                </a>
               <nav className="flex items-center gap-4 text-sm">
                  <a className="hover:text-orange-400" href="index.html">Home</a>
                  <a className="hover:text-orange-400" href="CritDmg-Calc.html">Critical Damage Calculator</a>
                  <a className="hover:text-orange-400" href="Penetration-Calc.html">Penetration Calculator</a>
                </nav>
              </div>
            </header>

            {/* Page content */}
            <div className="p-6">
              <div className="max-w-4xl mx-auto">
                <h1 className="text-3xl font-semibold mb-4">Critical Damage Calculator</h1>
                <p className="text-sm text-neutral-300 mb-6">
                  Toggle sources of Critical Damage, adjust stacks and %/stack to see your total. Sources are editable to
                  adjust to the current patch. The hard cap is also configurable for any future changes (CritDmg cap 125%).
                </p>
                <p className="text-sm text-semibold-50 mb-6">*Updated for patch 47.</p>

                <div className="flex flex-wrap items-center gap-3 mb-4">
                  <label className="flex items-center gap-2 bg-neutral-800 rounded-xl px-3 py-2">
                    <span className="text-sm">Crit Damage Cap</span>
                    <input
                      type="number"
                      value={cap}
                      onChange={(e) => setCap(toNumber(e.target.value, 0, 999))}
                      className="w-20 bg-neutral-900 rounded px-2 py-1"
                    />
                    <span className="text-sm">%</span>
                  </label>
                  <button onClick={addCustom} className="px-3 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-sm shadow">
                    Add custom row
                  </button>
                  <button onClick={resetAll} className="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-sm">
                    Reset toggles
                  </button>
                  <button onClick={exportConfig} className="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-sm">
                    Export config
                  </button>
                  <button onClick={importConfig} className="px-3 py-2 rounded-xl bg-neutral-800 hover:bg-neutral-700 text-sm">
                    Import config
                  </button>
                </div>

                <div className="overflow-x-auto rounded-2xl ring-1 ring-neutral-800">
                  <table className="min-w-full text-sm">
                    <thead className="bg-neutral-900/80">
                      <tr>
                        <th className="px-3 py-2 text-left">On</th>
                        <th className="px-3 py-2 text-left">Stacks</th>
                        <th className="px-3 py-2 text-left">Max</th>
                        <th className="px-3 py-2 text-left">Source</th>
                        <th className="px-3 py-2 text-left">% / stack</th>
                        <th className="px-3 py-2 text-right">Line total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {totals.rows.map((e) => (
                        <tr key={e.id} className="odd:bg-neutral-950 even:bg-neutral-900/40">
                          <td className="px-3 py-2">
                            <input
                              type="checkbox"
                              checked={e.on}
                              disabled={e.locked}
                              onChange={(ev) => update(e.id, { on: ev.target.checked })}
                            />
                          </td>
                          <td className="px-3 py-2">
                            <input
                              type="number"
                              min={0}
                              max={e.maxStacks}
                              value={e.stacks}
                              disabled={e.locked}
                              onChange={(ev) => update(e.id, { stacks: toNumber(ev.target.value, 0, e.maxStacks) })}
                              className="w-20 bg-neutral-900 rounded px-2 py-1"
                            />
                          </td>
                          <td className="px-3 py-2">
                            <input
                              type="number"
                              min={1}
                              value={e.maxStacks}
                              onChange={(ev) => update(e.id, { maxStacks: toNumber(ev.target.value, 1, 999) })}
                              className="w-20 bg-neutral-900 rounded px-2 py-1"
                            />
                          </td>
                          <td className="px-3 py-2">
                            <div className="flex flex-col">
                              <span className="font-medium">{e.name}</span>
                              {e.note ? <span className="text-xs text-neutral-400">{e.note}</span> : null}
                            </div>
                          </td>
                          <td className="px-3 py-2">
                            <div className="flex items-center gap-1">
                              <input
                                type="number"
                                value={e.perStack}
                                onChange={(ev) => update(e.id, { perStack: toNumber(ev.target.value, -999, 999) })}
                                className="w-20 bg-neutral-900 rounded px-2 py-1"
                              />
                              <span>%</span>
                            </div>
                          </td>
                          <td className="px-3 py-2 text-right">{e.line.toFixed(2)}%</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                  <StatCard
                    title="Raw Total"
                    value={`${totals.raw.toFixed(2)}%`}
                    subtitle="Sum of all enabled rows"
                    extraClass={colorForRaw(totals.raw)}
                  />
                  <StatCard title="Cap" value={`${cap}%`} subtitle="Hard limit applied" />
                  <StatCard title="Total (Capped)" value={`${totals.capped.toFixed(2)}%`} subtitle="What actually counts" />
                </div>

                <p className="text-xs text-neutral-400 mt-6">Tip: Adjust values to match your current patch if needed.</p>
              </div>

              <div className="mt-10 text-center text-xs text-neutral-500 space-y-2">
  <p>Last updated on 9/4/2025, for U47.</p>
  <p>Created and maintained by Askooma</p>
  <a 
    href="https://github.com/Askooma/Skooma-Tools/tree/main" 
    target="_blank" 
    rel="noopener noreferrer" 
    className="inline-block mt-2 text-neutral-400 hover:text-orange-400"
    aria-label="GitHub Repository"
  >
    <svg 
      xmlns="http://www.w3.org/2000/svg" 
      viewBox="0 0 24 24" 
      fill="currentColor" 
      className="w-6 h-6 mx-auto"
    >
      <path d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.438 9.8 8.207 11.387.6.113.793-.262.793-.583 
        0-.288-.01-1.05-.016-2.06-3.338.726-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.756-1.333-1.756-1.09-.745.083-.73.083-.73 
        1.205.085 1.84 1.237 1.84 1.237 1.07 1.835 2.807 1.305 3.492.998.108-.775.418-1.305.762-1.605-2.665-.305-5.467-1.335-5.467-5.93 
        0-1.31.468-2.382 1.236-3.222-.124-.303-.536-1.527.117-3.176 
        0 0 1.008-.322 3.3 1.23a11.5 11.5 0 013.003-.404c1.02.005 2.047.137 3.003.404 
        2.29-1.552 3.297-1.23 3.297-1.23.655 1.649.243 2.873.12 3.176.77.84 
        1.235 1.912 1.235 3.222 0 4.61-2.807 5.624-5.48 5.92.43.37.823 1.096.823 2.21 
        0 1.595-.015 2.88-.015 3.27 0 .324.192.7.8.58C20.565 21.796 24 17.297 
        24 12c0-6.63-5.37-12-12-12z"/>
    </svg>
  </a>
</div>

            </div>
          </div>
        );
      }

      function StatCard({ title, value, subtitle, extraClass }) {
        return (
          <div className="rounded-2xl bg-neutral-900 p-4 ring-1 ring-neutral-800 shadow">
            <div className="text-sm text-neutral-400">{title}</div>
            <div className={`text-3xl font-semibold ${extraClass || ""}`}>{value}</div>
            <div className="text-xs text-neutral-400 mt-1">{subtitle}</div>
          </div>
        );
      }

      function round2(n) { return Math.round(n * 100) / 100; }
      function clamp(n, a, b) { return Math.max(a, Math.min(b, Number.isFinite(n) ? n : a)); }
      function toNumber(v, min, max) { return clamp(Number(v), min, max); }

      // Color for the Raw Total metric
      function colorForRaw(raw) {
        if (raw < 125) return "text-red-500";
        if (raw >= 125 && raw <= 130) return "text-green-500";
        if (raw > 130) return "text-blue-500";
        return "";
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ESOCritCalculator />);
    </script>
  </body>
</html>
